<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>D·ª± b√°o th·ªùi ti·∫øt t·ª´ IP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    .card { @apply bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-6; }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center bg-gradient-to-b from-sky-300 via-white to-sky-100 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 p-6 transition-colors duration-500">
  <div class="max-w-5xl w-full">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-bold text-slate-800 dark:text-slate-200">D·ª± b√°o th·ªùi ti·∫øt ‚Äî t·ª´ IP</h1>
      <div class="flex gap-2">
        <button id="toggleTheme" class="px-4 py-2 rounded-xl bg-purple-500 hover:bg-purple-600 text-white shadow-lg transition">üåô / ‚òÄÔ∏è</button>
        <button id="toggleUnits" class="px-4 py-2 rounded-xl bg-sky-500 hover:bg-sky-600 text-white shadow-lg transition">ƒê·ªïi ¬∞C/¬∞F</button>
      </div>
    </header>

    <main class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <section class="md:col-span-2 card flex flex-col gap-6" id="weatherSection">
        <div id="loading" class="text-center text-slate-500 dark:text-slate-400">ƒêang t·∫£i...</div>
      </section>

      <aside class="card flex flex-col gap-4" id="sidebar"></aside>
    </main>

    <footer class="mt-6 text-center text-sm text-slate-500 dark:text-slate-400">Thi·∫øt k·∫ø si√™u ƒë·∫πp, responsive ‚Äî d√πng IP ƒë·ªÉ x√°c ƒë·ªãnh v·ªã tr√≠. To√†n b·ªô API ƒë·ªÅu kh√¥ng c·∫ßn key, c√≥ d·ª± ph√≤ng.</footer>
  </div>

  <script>
    const toggleBtn = document.getElementById('toggleUnits')
    const toggleTheme = document.getElementById('toggleTheme')
    const weatherSection = document.getElementById('weatherSection')
    const sidebar = document.getElementById('sidebar')
    let units = 'metric' // or 'imperial'

    function cToF(c){ return Math.round((c*9)/5+32) }
    function formatTemp(c){
      if(c===null||c===undefined) return '‚Äî'
      return units==='metric'? Math.round(c)+"¬∞C" : cToF(c)+"¬∞F"
    }

    function formatHour(iso){
      try{ return new Date(iso).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) }catch(e){ return iso }
    }

    const WMO_MAP_VI = {0:'Tr·ªùi quang',1:'√çt m√¢y',2:'Nhi·ªÅu m√¢y',3:'U √°m',45:'S∆∞∆°ng m√π',48:'S∆∞∆°ng m√π ƒë√≥ng bƒÉng',51:'M∆∞a ph√πn nh·∫π',53:'M∆∞a ph√πn v·ª´a',55:'M∆∞a ph√πn n·∫∑ng',61:'M∆∞a nh·∫π',63:'M∆∞a v·ª´a',65:'M∆∞a to',80:'M∆∞a r√†o nh·∫π',81:'M∆∞a r√†o v·ª´a',82:'M∆∞a r√†o m·∫°nh',95:'Gi√¥ng b√£o',99:'Gi√¥ng k√®m m∆∞a ƒë√° m·∫°nh'}
    function desc(code){ return WMO_MAP_VI[code]||'‚Äî' }

    async function fetchLocation(){
      try{
        let res = await fetch('https://ipapi.co/json/')
        if(!res.ok) throw new Error('ipapi l·ªói')
        return await res.json()
      }catch(e){
        try{
          let res = await fetch('https://ipwho.is/')
          return await res.json()
        }catch(e2){
          let res = await fetch('https://freeipapi.com/api/json')
          return await res.json()
        }
      }
    }

    async function fetchWeather(lat,lon){
      try{
        let url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,precipitation_probability,weathercode&current_weather=true&daily=temperature_2m_max,temperature_2m_min,weathercode,sunrise,sunset&timezone=auto&forecast_days=7`
        let res = await fetch(url)
        return await res.json()
      }catch(e){
        let res = await fetch(`https://wttr.in/${lat},${lon}?format=j1`)
        return await res.json()
      }
    }

    async function loadWeather(){
      weatherSection.innerHTML = '<div id="loading" class="text-center text-slate-500 dark:text-slate-400">ƒêang t·∫£i...</div>'
      try{
        const loc = await fetchLocation()
        const lat = parseFloat(loc.latitude || (loc.loc?loc.loc.split(",")[0]: loc.latitude || 0))
        const lon = parseFloat(loc.longitude || (loc.loc?loc.loc.split(",")[1]: loc.longitude || 0))
        const weather = await fetchWeather(lat,lon)

        // Hi·ªÉn th·ªã
        let html = ''
        html += `<div class='flex items-center justify-between'>
                  <div>
                    <div class='text-slate-500 dark:text-slate-400 text-sm'>B√¢y gi·ªù</div>
                    <div class='flex items-end gap-4'>
                      <div class='text-5xl font-bold text-slate-800 dark:text-slate-100'>${formatTemp(weather.current_weather.temperature)}</div>
                      <div class='text-slate-600 dark:text-slate-300'>${desc(weather.current_weather.weathercode)}</div>
                    </div>
                  </div>
                  <div class='text-slate-500 dark:text-slate-400 text-sm'>Gi√≥: ${weather.current_weather.windspeed} m/s</div>
                </div>`

        html += `<div class='mt-4'><div class='text-slate-500 dark:text-slate-400 text-sm mb-2'>D·ª± b√°o gi·ªù t·ªõi</div><div class='overflow-x-auto flex gap-3 py-2'>`
        let hours = weather.hourly.time.slice(0,12)
        for(let i=0;i<hours.length;i++){
          html += `<div class='min-w-[88px] bg-slate-50 dark:bg-slate-700 rounded-xl p-3 text-center'>
                      <div class='text-xs text-slate-600 dark:text-slate-300'>${formatHour(weather.hourly.time[i])}</div>
                      <div class='my-1 text-sm font-medium text-slate-800 dark:text-slate-100'>${formatTemp(weather.hourly.temperature_2m[i])}</div>
                      <div class='text-xs text-slate-500 dark:text-slate-400'>${Math.round(weather.hourly.precipitation_probability[i]||0)}% m∆∞a</div>
                   </div>`
        }
        html += `</div></div>`

        html += `<div class='mt-6'><div class='text-slate-500 dark:text-slate-400 text-sm mb-2'>7 ng√†y t·ªõi</div><div class='grid grid-cols-2 md:grid-cols-4 gap-3'>`
        for(let i=0;i<7;i++){
          html += `<div class='p-3 bg-white dark:bg-slate-700 border rounded-lg shadow-sm flex flex-col items-start gap-1'>
                    <div class='text-xs text-slate-500 dark:text-slate-400'>${new Date(weather.daily.time[i]).toLocaleDateString()}</div>
                    <div class='flex items-center gap-3 w-full'>
                      <div class='flex-1 font-medium text-slate-800 dark:text-slate-100'>${formatTemp(weather.daily.temperature_2m_max[i])}</div>
                      <div class='w-12 text-slate-600 dark:text-slate-300'>${formatTemp(weather.daily.temperature_2m_min[i])}</div>
                    </div>
                    <div class='text-xs text-slate-500 dark:text-slate-400'>${desc(weather.daily.weathercode[i])}</div>
                  </div>`
        }
        html += `</div></div>`

        weatherSection.innerHTML = html

        sidebar.innerHTML = `<div class='text-sm text-slate-500 dark:text-slate-400'>Th√¥ng tin nhanh</div>
                             <div class='text-xs text-slate-500 dark:text-slate-400'>V·ªã tr√≠: ${loc.city||loc.regionName||''}, ${loc.region||loc.country||''}</div>
                             <div class='text-xs text-slate-500 dark:text-slate-400'>M·∫∑t tr·ªùi m·ªçc: ${weather.daily.sunrise[0]}</div>
                             <div class='text-xs text-slate-500 dark:text-slate-400'>M·∫∑t tr·ªùi l·∫∑n: ${weather.daily.sunset[0]}</div>`
      }catch(e){
        weatherSection.innerHTML = `<div class='text-red-600'>L·ªói: ${e.message}</div>`
      }
    }

    toggleBtn.addEventListener('click',()=>{
      units = units==='metric'?'imperial':'metric'
      loadWeather()
    })

    toggleTheme.addEventListener('click',()=>{
      document.documentElement.classList.toggle('dark')
    })

    loadWeather()
  </script>
</body>
</html>
